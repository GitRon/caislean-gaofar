name: QA Pipeline

# Trigger on push and pull requests to main branch
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # Allow manual workflow dispatch
  workflow_dispatch:

jobs:
  autoupdate:
    name: Check Hook Updates
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't block other jobs if this fails

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Python 3.13
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # 3. Install uv
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      # 4. Install pre-commit
      - name: Install pre-commit
        run: |
          uv pip install --system pre-commit

      # 5. Check for hook updates
      - name: Check for pre-commit hook updates
        run: |
          echo "Checking for pre-commit hook updates..."
          pre-commit autoupdate

          if [ -n "$(git status --porcelain .pre-commit-config.yaml)" ]; then
            echo "::warning::Pre-commit hooks have updates available! Check the diff below:"
            echo "::warning::Consider updating .pre-commit-config.yaml to the latest versions"
            git diff .pre-commit-config.yaml
          else
            echo "All pre-commit hooks are up to date ✓"
          fi

  linting:
    name: Code Linting
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Python 3.13
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # 3. Install uv
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      # 4. Install pre-commit
      - name: Install pre-commit
        run: |
          uv pip install --system pre-commit

      # 5. Run pre-commit hooks
      - name: Run pre-commit checks
        run: |
          pre-commit run --all-files

  typechecking:
    name: Type Checking (ty)
    runs-on: ubuntu-latest
    # Run independently - don't block other jobs
    continue-on-error: true

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Python 3.13
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # 3. Install uv
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      # 4. Install dependencies (including ty)
      - name: Install dependencies
        run: |
          uv sync --frozen

      # 5. Run ty type checker
      - name: Run ty type checker
        run: |
          uv run ty check src/
          echo "✓ Type checking completed. Found issues are tracked for gradual improvement."

  testing:
    name: Testing & Coverage
    runs-on: ubuntu-latest
    needs: linting  # Only run after linting passes

    steps:
      # 1. Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Python 3.13
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      # 3. Install uv
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      # 4. Install dependencies using uv with lock file
      - name: Install dependencies
        run: |
          uv sync --frozen

      # 5. Run tests with branch coverage
      - name: Run tests with coverage
        run: |
          uv run pytest --cov=. --cov-report=term-missing --cov-report=xml --cov-branch --cov-fail-under=100 \
            --cov-config=pyproject.toml tests/ -v

      # 6. Upload coverage report
      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      # 7. Generate coverage badge data
      - name: Coverage Badge
        if: always()
        run: |
          COVERAGE=$(uv run python -m coverage report --omit="tests/*,main.py" | grep TOTAL | awk '{print $NF}' | sed 's/%//')
          echo "Coverage: ${COVERAGE}%"

          if [ -z "$COVERAGE" ]; then
            echo "❌ Failed to get coverage data"
            exit 1
          fi

          if (( $(echo "$COVERAGE >= 100" | bc -l) )); then
            echo "✅ 100% branch coverage achieved!"
          else
            echo "❌ Coverage is ${COVERAGE}%, expected 100%"
            exit 1
          fi

